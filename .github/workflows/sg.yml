name: Secrets Guard Integration

on:
  push:
    branches: [ "main" ]

jobs:
  sg-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build Intent (real added-lines diff-only)
        env:
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          COMMIT: ${{ github.sha }}
          BEFORE: ${{ github.event.before }}
        run: |
          set -euo pipefail

          BASE="$BEFORE"
          if [ -z "$BASE" ] || [ "$BASE" = "0000000000000000000000000000000000000000" ]; then
            BASE="$(git hash-object -t tree /dev/null)"
          fi

          git diff --unified=0 "$BASE" "$COMMIT" > diff.patch

          python3 -c 'import json,re,os; repo=os.environ.get("REPO",""); ref=os.environ.get("REF",""); commit=os.environ.get("COMMIT",""); data=open("diff.patch","r",encoding="utf-8",errors="replace").read().splitlines(); diff=[]; path=None; line=None; h=re.compile(r"^@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@"); 
for s in data:
  if s.startswith("+++ b/"): path=s[6:].strip(); line=None; continue
  m=h.match(s)
  if m: line=int(m.group(1)); continue
  if path and line is not None and s.startswith("+") and not s.startswith("+++"): diff.append({"path":path,"line":line,"added":s[1:]}); line+=1
intent={"intent":{"action_type":"GIT_COMMIT_DIFF","payload":{"repo":repo,"ref":ref,"commit":commit,"diff_facts":diff}}}; 
json.dump(intent,open("intent.json","w",encoding="utf-8"),ensure_ascii=False,separators=(",",":"))'

          echo "DIFF_FACTS_COUNT=$(jq '.intent.payload.diff_facts | length' intent.json)"

      - name: Call Authority (hard fail on DENY)
        env:
          AUTHORITY_URL: http://107.172.34.21:8787
        run: |
          set -euo pipefail

          curl -sS -X POST "$AUTHORITY_URL/admit" \
            -H "Content-Type: application/json" \
            --data-binary @intent.json > response.json

          decision="$(jq -r '.signed_record.decision' response.json)"
          echo "DECISION=$decision"

          if [ "$decision" = "DENY" ]; then
            echo "Blocked by Authority"
            exit 1
          fi